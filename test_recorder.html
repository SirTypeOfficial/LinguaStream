<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaStream - ØªØ³Øª Ø¶Ø¨Ø· ØµØ¯Ø§</title>
    <link rel="stylesheet" href="static/css/audio_recorder.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ ØªØ³Øª Ø¶Ø¨Ø· ØµØ¯Ø§</h1>
        
        <div class="audio-recorder-container">
            <div class="recording-controls">
                <button class="record-button" id="recordBtn" onclick="startRecording()">
                    ğŸ¤
                </button>
                <button class="stop-button" id="stopBtn" onclick="stopRecording()" disabled>
                    â¹ï¸
                </button>
            </div>
            
            <div class="audio-level-meter">
                <div class="audio-level-bar" id="audioLevelBar"></div>
            </div>
            
            <div class="recording-status status-ready" id="recordingStatus">
                Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø·
            </div>
            
            <div class="recording-timer" id="recordingTimer">00:00</div>
        </div>
        
        <div class="transcription-result" id="transcriptionResult">
            Ù…ØªÙ† ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...
        </div>
    </div>

    <script src="static/js/audio_recorder.js"></script>
    <script>
        let recordingInterval;
        let timerInterval;
        let startTime;
        
        async function startRecording() {
            try {
                const success = await window.audioRecorder.startRecording();
                if (success) {
                    document.getElementById('recordBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('recordingStatus').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø·...';
                    document.getElementById('recordingStatus').className = 'recording-status status-recording';
                    
                    startTime = Date.now();
                    timerInterval = setInterval(updateTimer, 100);
                    
                    // Ø´Ø±ÙˆØ¹ Ù†Ù…Ø§ÛŒØ´ Ø³Ø·Ø­ ØµØ¯Ø§
                    window.audioRecorder.startAudioLevelMonitoring(updateAudioLevel);
                }
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø·: ' + error.message);
            }
        }
        
        async function stopRecording() {
            try {
                const audioBlob = await window.audioRecorder.stopRecording();
                if (audioBlob) {
                    document.getElementById('recordBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('recordingStatus').textContent = 'Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµØ¯Ø§...';
                    document.getElementById('recordingStatus').className = 'recording-status status-processing';
                    
                    clearInterval(timerInterval);
                    window.audioRecorder.stopAudioLevelMonitoring();
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„
                    document.getElementById('transcriptionResult').innerHTML = 
                        `ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø¶Ø¨Ø· Ø´Ø¯!<br>Ø§Ù†Ø¯Ø§Ø²Ù‡: ${(audioBlob.size / 1024).toFixed(2)} KB<br>Ù†ÙˆØ¹: ${audioBlob.type}`;
                    
                    // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª
                    setTimeout(() => {
                        document.getElementById('recordingStatus').textContent = 'âœ… Ø¶Ø¨Ø· Ú©Ø§Ù…Ù„ Ø´Ø¯';
                        document.getElementById('recordingStatus').className = 'recording-status status-ready';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error stopping recording:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ‚Ù Ø¶Ø¨Ø·: ' + error.message);
            }
        }
        
        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('recordingTimer').textContent = 
                String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        }
        
        function updateAudioLevel(level) {
            const percentage = Math.min(level * 2, 100); // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¯Ø±ØµØ¯
            document.getElementById('audioLevelBar').style.width = percentage + '%';
        }
        
        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
        window.addEventListener('load', async () => {
            try {
                const success = await window.audioRecorder.requestMicrophonePermission();
                if (success) {
                    console.log('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† ØªØ£ÛŒÛŒØ¯ Ø´Ø¯');
                } else {
                    alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø±Ø¯ Ø´Ø¯!');
                }
            } catch (error) {
                console.error('Error requesting microphone permission:', error);
            }
        });
    </script>
</body>
</html>
