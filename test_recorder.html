<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaStream - تست ضبط صدا</title>
    <link rel="stylesheet" href="static/css/audio_recorder.css">
</head>
<body>
    <div class="container">
        <h1>🎤 تست ضبط صدا</h1>
        
        <div class="audio-recorder-container">
            <div class="recording-controls">
                <button class="record-button" id="recordBtn" onclick="startRecording()">
                    🎤
                </button>
                <button class="stop-button" id="stopBtn" onclick="stopRecording()" disabled>
                    ⏹️
                </button>
            </div>
            
            <div class="audio-level-meter">
                <div class="audio-level-bar" id="audioLevelBar"></div>
            </div>
            
            <div class="recording-status status-ready" id="recordingStatus">
                آماده برای ضبط
            </div>
            
            <div class="recording-timer" id="recordingTimer">00:00</div>
        </div>
        
        <div class="transcription-result" id="transcriptionResult">
            متن تشخیص داده شده اینجا نمایش داده می‌شود...
        </div>
    </div>

    <script src="static/js/audio_recorder.js"></script>
    <script>
        let recordingInterval;
        let timerInterval;
        let startTime;
        
        async function startRecording() {
            try {
                const success = await window.audioRecorder.startRecording();
                if (success) {
                    document.getElementById('recordBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('recordingStatus').textContent = 'در حال ضبط...';
                    document.getElementById('recordingStatus').className = 'recording-status status-recording';
                    
                    startTime = Date.now();
                    timerInterval = setInterval(updateTimer, 100);
                    
                    // شروع نمایش سطح صدا
                    window.audioRecorder.startAudioLevelMonitoring(updateAudioLevel);
                }
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('خطا در شروع ضبط: ' + error.message);
            }
        }
        
        async function stopRecording() {
            try {
                const audioBlob = await window.audioRecorder.stopRecording();
                if (audioBlob) {
                    document.getElementById('recordBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('recordingStatus').textContent = 'پردازش صدا...';
                    document.getElementById('recordingStatus').className = 'recording-status status-processing';
                    
                    clearInterval(timerInterval);
                    window.audioRecorder.stopAudioLevelMonitoring();
                    
                    // نمایش اطلاعات فایل
                    document.getElementById('transcriptionResult').innerHTML = 
                        `فایل صوتی ضبط شد!<br>اندازه: ${(audioBlob.size / 1024).toFixed(2)} KB<br>نوع: ${audioBlob.type}`;
                    
                    // تغییر وضعیت
                    setTimeout(() => {
                        document.getElementById('recordingStatus').textContent = '✅ ضبط کامل شد';
                        document.getElementById('recordingStatus').className = 'recording-status status-ready';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error stopping recording:', error);
                alert('خطا در توقف ضبط: ' + error.message);
            }
        }
        
        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('recordingTimer').textContent = 
                String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        }
        
        function updateAudioLevel(level) {
            const percentage = Math.min(level * 2, 100); // تبدیل به درصد
            document.getElementById('audioLevelBar').style.width = percentage + '%';
        }
        
        // درخواست دسترسی به میکروفن هنگام بارگذاری صفحه
        window.addEventListener('load', async () => {
            try {
                const success = await window.audioRecorder.requestMicrophonePermission();
                if (success) {
                    console.log('دسترسی میکروفن تأیید شد');
                } else {
                    alert('دسترسی میکروفن رد شد!');
                }
            } catch (error) {
                console.error('Error requesting microphone permission:', error);
            }
        });
    </script>
</body>
</html>
